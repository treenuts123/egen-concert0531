<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>티켓 예매</title>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    // Supabase 연결
    const supabaseUrl = 'https://sdnbavlcgejmvdtmzbep.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkbmJhdmxjZ2VqbXZkdG16YmVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUzNzM3OTEsImV4cCI6MjA2MDk0OTc5MX0.fmLedtsLoY140wrbyFmITQiu0BZQUfQxs-qIX7LmibQ'
    const supabase = createClient(supabaseUrl, supabaseKey)

    let maxSeats = 50;
    let currentSeats = 0;

    async function fetchCurrentReservations() {
      const { data, error } = await supabase
        .from('reservations')
        .select('count, status')

      if (error) {
        console.error('잔여좌석 불러오기 실패', error)
        return;
      }

      const validReservations = data.filter(r => r.status === '입금대기' || r.status === '입금완료');
      currentSeats = validReservations.reduce((sum, r) => sum + (r.count || 0), 0);
      updateSeatDisplay();
    }

    function updateSeatDisplay() {
      const remaining = maxSeats - currentSeats;
      document.getElementById('seatInfo').innerText = `남은 좌석: ${remaining} / ${maxSeats}`;
    }

    window.addEventListener('load', fetchCurrentReservations);

    // 예약 진행 상태
    let reservationInfo = {};

    window.handleReserveClick = function() {
      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const count = parseInt(document.getElementById('count').value);

      const water = parseInt(document.getElementById('water').value);
      const cola = parseInt(document.getElementById('cola').value);
      const pocari = parseInt(document.getElementById('pocari').value);
      const beer = parseInt(document.getElementById('beer').value);

      if (!name || !phone || !count) {
        alert('모든 필드를 입력해 주세요.');
        return;
      }

      const totalDrinks = water + cola + pocari + beer;
      if (totalDrinks > count) {
        alert('선택한 웰컴드링크 수량이 인원수보다 많습니다.');
        return;
      }

      reservationInfo = {
        name,
        phone,
        count,
        welcome_drinks: {
          "물": water,
          "콜라": cola,
          "포카리": pocari,
          "맥주": beer
        }
      };

      // 입력폼 숨기고 확인창 보여줌
      document.getElementById('inputArea').style.display = 'none';
      document.getElementById('confirmArea').style.display = 'block';

      // 예매자 정보 표시
      document.getElementById('confirmInfo').innerHTML = `
        <p>이름: ${name}</p>
        <p>전화번호: ${phone}</p>
        <p>인원수: ${count}</p>
        <p>웰컴드링크: 물 ${water}개, 콜라 ${cola}개, 포카리 ${pocari}개, 맥주 ${beer}개</p>
        <p>입금 계좌번호: 우리은행 123-456789-01-234 (예금주: 트리넛츠)</p>
      `;
    }

    window.handleModifyClick = function() {
      // 수정하기 눌렀을 때 입력폼 복귀
      document.getElementById('inputArea').style.display = 'block';
      document.getElementById('confirmArea').style.display = 'none';
    }

    function generateBookingNumber() {
      return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    window.handleCompleteClick = async function() {
      const booking_number = generateBookingNumber();

      const { data, error } = await supabase
        .from('reservations')
        .insert([
          {
            name: reservationInfo.name,
            phone: reservationInfo.phone,
            count: reservationInfo.count,
            welcome_drinks: reservationInfo.welcome_drinks,
            booking_number: booking_number,
            status: '입금대기'
          }
        ]);

      if (error) {
        console.error('예매 저장 실패', error)
        alert('예매 저장 중 오류가 발생했습니다.');
        return;
      }

      // 화면 교체
      document.getElementById('confirmArea').style.display = 'none';
      document.getElementById('completeArea').style.display = 'block';

      document.getElementById('completeInfo').innerHTML = `
        <p>예매가 완료되었습니다!</p>
        <p>예약자명: ${reservationInfo.name}</p>
        <p>전화번호: ${reservationInfo.phone}</p>
        <p>예약번호: ${booking_number}</p>
        <p>※ 예매확인 페이지에서 예약번호로 조회할 수 있습니다.</p>
      `;

      // 남은좌석 다시 불러오기
      fetchCurrentReservations();
    }

    window.moveToConfirm = function() {
      window.location.href = 'confirm.html';
    }

    window.goBack = function() {
      window.location.href = 'index.html';
    }
  </script>
</head>
<body>
  <h1>티켓 예매</h1>
  <div id="seatInfo">남은 좌석: 불러오는 중...</div>
  
  <div id="inputArea">
    <p><input type="text" id="name" placeholder="이름"></p>
    <p><input type="text" id="phone" placeholder="전화번호"></p>
    <p>
      인원수:
      <select id="count">
        <option value="1">1명</option>
        <option value="2">2명</option>
        <option value="3">3명</option>
        <option value="4">4명</option>
        <option value="5">5명</option>
      </select>
    </p>
    <h3>웰컴드링크 선택 (인원수 이내)</h3>
    <p>물: 
      <select id="water">
        <option value="0">0개</option><option value="1">1개</option><option value="2">2개</option><option value="3">3개</option><option value="4">4개</option><option value="5">5개</option>
      </select>
    </p>
    <p>콜라: 
      <select id="cola">
        <option value="0">0개</option><option value="1">1개</option><option value="2">2개</option><option value="3">3개</option><option value="4">4개</option><option value="5">5개</option>
      </select>
    </p>
    <p>포카리: 
      <select id="pocari">
        <option value="0">0개</option><option value="1">1개</option><option value="2">2개</option><option value="3">3개</option><option value="4">4개</option><option value="5">5개</option>
      </select>
    </p>
    <p>맥주: 
      <select id="beer">
        <option value="0">0개</option><option value="1">1개</option><option value="2">2개</option><option value="3">3개</option><option value="4">4개</option><option value="5">5개</option>
      </select>
    </p>

    <p>
      <button onclick="handleReserveClick()">예매하기</button>
      <button onclick="moveToConfirm()">예매확인</button>
      <button onclick="goBack()">뒤로가기</button>
    </p>
  </div>

  <div id="confirmArea" style="display: none;">
    <div id="confirmInfo"></div>
    <p>
      <button onclick="handleCompleteClick()">예매완료</button>
      <button onclick="handleModifyClick()">수정하기</button>
    </p>
  </div>

  <div id="completeArea" style="display: none;">
    <div id="completeInfo"></div>
    <p><button onclick="goBack()">뒤로가기</button></p>
  </div>

</body>
</html>
